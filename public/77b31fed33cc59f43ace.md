---
title: ã€Dockerã€‘ãƒ›ã‚¹ãƒˆå´ã§yarn installãŠã‚ˆã³yarn addãŒã§ããªã„ã‚ˆã†ã«ã™ã‚‹
tags:
  - Docker
  - dockerfile
  - docker-compose
  - åˆå­¦è€…
  - node_modeles
private: false
updated_at: '2023-03-30T17:25:12+09:00'
id: 77b31fed33cc59f43ace
organization_url_name: null
slide: false
ignorePublish: false
---
## `node_modules`ã®å–ã‚Šæ‰±ã„ã«ã¯æ³¨æ„ãŒå¿…è¦
Dockerã‚’åˆ©ç”¨ã—ã¦ç’°å¢ƒæ§‹ç¯‰ã‚’ã™ã‚‹éš›ã«ã¯`node_modules`ã®å–ã‚Šæ‰±ã„ã«æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
ä½•ã‚‚æ„è­˜ã—ã¦ã„ãªã„ã¨ãƒ›ã‚¹ãƒˆå´ã§`yarn install`ãªã©ã‚’ã—ã¦ã—ã¾ã†ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚  

https://qiita.com/P-man_Brown/items/db1996bdee33ee667741

ã¾ãŸ`yarn install`ãªã©ã‚’`Dockerfile`ã§å®Ÿè¡Œã—ãŸéš›ã«`node_modules`ãŒå‰Šé™¤ã•ã‚ŒãŸã‚Šã—ã¾ã™ã€‚  

ä»¥ä¸‹ã®è¨˜äº‹ã§ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã®node_modulesãŒæ¶ˆãˆã‚‹å•é¡Œã®æ”¹å–„æ–¹æ³•ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

https://qiita.com/P-man_Brown/items/c2a69d943853cb381fbe

ã—ã‹ã—ã€ä¸Šè¨˜ã®è¨˜äº‹ã«è¨˜è¼‰ã—ã¦ã„ã‚‹æ–¹æ³•ã§ã¯ãƒ›ã‚¹ãƒˆå´ã®`node_modules`ãŒç©ºã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚
ãã®æ”¹å–„æ–¹æ³•ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã«ã¾ã¨ã‚ã¾ã—ãŸã€‚

https://qiita.com/P-man_Brown/items/5a82ad98cb96206343b9

è¨˜äº‹ã®ã‚ˆã†ã«è¨­å®šã™ã‚‹ã¨ãƒ›ã‚¹ãƒˆå´ã«`node_modules`ã®ä¸­èº«ã‚’è¡¨ç¤ºã§ãã¾ã™ãŒã€ãƒ›ã‚¹ãƒˆå´ã®å¤‰æ›´ãŒã‚³ãƒ³ãƒ†ãƒŠå†…ã«åæ˜ ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ãƒ›ã‚¹ãƒˆå´ã§`yarn install`ãªã©ã‚’ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ãªã‚‹ãŸã‚ã€ä»Šå›ã¯ãƒ›ã‚¹ãƒˆå´ã®`node_modules`ãŒç©ºã«ãªã‚‹å•é¡Œã®æ”¹å–„æ–¹æ³•ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚
`Next.js`ã®ç’°å¢ƒã§è©¦ã—ãŸã®ã§`Next.js`ã§è¨˜è¼‰ã—ã¾ã™ãŒä»–ã§ã‚‚å¿œç”¨å¯èƒ½ã¨æ€ã„ã¾ã™ã€‚

### ãƒ›ã‚¹ãƒˆå´ã§`yarn install`ãªã©ã‚’ä¸å¯ã«ã™ã‚‹
ãƒ›ã‚¹ãƒˆå´ã§`yarn install`ã‚„`yarn add`ã‚’ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§å¯¾å¿œã—ã¾ã™ã€‚
ã¾ãšã€`.yarnrc`ã‚’ä½œæˆã—ã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-04-29 23.03.16.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2342443/147234ee-1643-704c-42f6-1df49021817f.png)
ãã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚

```.yarnrc
--modules-folder /myapp/node_modules
```

yarnã‚’ä½¿ç”¨ã—ãŸéš›ã«`--modules-folder /myapp/node_modules`ãŒã¤ãã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`--modules-folder`ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://classic.yarnpkg.com/en/docs/cli/install


æ¬¡ã«Dockerfileã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```Dockerfile:Dockerfile
FROM node:16.14.2

ENV USER_NAME=myuser
ENV TZ=Asia/Tokyo
# PATH è¿½è¨˜
ENV PATH="/myapp/node_modules/.bin:$PATH"

WORKDIR /myapp

# .yarnrc è¿½è¨˜
COPY package.json yarn.lock .yarnrc ./
RUN yarn install --frozen-lockfile

RUN adduser ${USER_NAME} && \
  chown -R ${USER_NAME} /myapp
USER ${USER_NAME}

EXPOSE 3000
CMD ["yarn", "dev"]
```

ã“ã‚Œã§ã€`yarn install`ã‚’ãƒ›ã‚¹ãƒˆå´ã§å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦`yarn install`ã§ããªããªã‚Šã¾ã™ã€‚

```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ yarn install
yarn install v1.22.17
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
[3/4] ğŸ”—  Linking dependencies...
error An unexpected error occurred: "EROFS: read-only file system, mkdir '/myapp'".
info If you think this is a bug, please open a bug report with the information provided
in "/Users/user_name/Documents/sources/docker-next-test/Next/yarn-error.log".
info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
```

`yarn add`ã‚‚åŒæ§˜ã§ã™ã€‚

```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ yarn add <package>
yarn add v1.22.17
[1/5] ğŸ”  Validating package.json...
[2/5] ğŸ”  Resolving packages...
[3/5] ğŸšš  Fetching packages...
[4/5] ğŸ”—  Linking dependencies...
error An unexpected error occurred: "EROFS: read-only file system, mkdir '/myapp'".
info If you think this is a bug, please open a bug report with the information provided
in "/Users/user_name/Documents/sources/docker-next-test/Next/yarn-error.log".
info Visit https://yarnpkg.com/en/docs/cli/add for documentation about this command.
```

ã¾ãŸã€ã“ã‚Œã¯ãƒ›ã‚¹ãƒˆå´ã§`yarn install`ãªã©ã‚’ä¸å¯ã«ã™ã‚‹ä»–ã«ã‚‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªäº‹è±¡ã‚’æ”¹å–„ã—ã¾ã™ã€‚

`node_modules`ã«ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’è¨­å®šã—ãŸçŠ¶æ…‹ã§ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚³ãƒ³ãƒ†ãƒŠå´ã®`node_modules`ãŒç©ºã«ãªã‚Šã¾ã™ã€‚

```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ docker compose run --rm front yarn create next-app --ts myapp_name && \
  cd $_ && mv * .* .. && rmdir ${PWD} && cd ../
```

ãƒ›ã‚¹ãƒˆå´ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å±•é–‹ã™ã‚‹ãŸã‚ã“ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

ã—ã‹ã—ã“ã‚Œã§ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®`/myapp/node_modules`ã«å¤‰æ›´ãŒåæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚
ã‚³ãƒ³ãƒ†ãƒŠå†…ã®`node_modules`ã¯ç©ºã®ã¾ã¾ã§ã‚ã‚‹ãŸã‚ã€`docker compose up`ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚
```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ docker compose up
[+] Running 1/0
 â ¿ Container next-front-1  Created                                                0.1s
Attaching to next-front-1
next-front-1  | yarn run v1.22.18
next-front-1  | $ next dev
next-front-1  | /bin/sh: 1: next: not found
next-front-1  | info Visit https://yarnpkg.com/en/docs/cli/run for documentation about
this command.
next-front-1  | error Command failed with exit code 127.
next-front-1 exited with code 127
```

`.yarnrc`ã‚’å‰è¿°ã®ã¨ãŠã‚Šä½œæˆã™ã‚‹ã¨`/myapp/node_modules`ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ãŸã‚ã€ã“ã®å•é¡Œã‚‚æ”¹å–„ã•ã‚Œã¾ã™ã€‚


ã“ã‚Œã§`yarn install`ãªã©ã¯ã§ããªããªã‚Šã¾ã—ãŸãŒã€ã¾ã `npm install`ã¯ã§ãã¦ã—ã¾ã„ã¾ã™ã€‚
`node_modules`ãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹ã§ãƒ›ã‚¹ãƒˆå´ã§`npm install`ã—ãŸã‚Šã€ãƒ›ã‚¹ãƒˆå´ã§`npm ci`ã‚’å®Ÿè¡Œã—ã¦ã—ã¾ã†ã¨ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
è©³ç´°ã¯ä»¥ä¸‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://qiita.com/P-man_Brown/items/db1996bdee33ee667741#npm%E3%81%AE%E5%A0%B4%E5%90%88

ã¾ãŸã€yarnã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã«`npm install`ã—ã¦ã—ã¾ã†ã¨`yarn.lock`ã®ä»–ã«`package-lock.json`ã‚‚ä½œæˆã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€æ¬¡ã¯`npm install`ã‚‚ã§ããªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
`npm install`ã‚’ã§ããªã„ã‚ˆã†ã«ã™ã‚‹æ–¹æ³•ã¯ä»¥ä¸‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://qiita.com/P-man_Brown/items/625f55f615fb97293d1f


### yarn V3ã®å ´åˆ

:::note warn
è­¦å‘Š
ä»¥é™ã«è¨˜è¿°ã—ãŸæ–¹æ³•ã§ã¯Dependabotã‚’ä½¿ç”¨ã—ãŸéš›ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2023-03-30 17.23.21.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2342443/45bd7aea-842e-7976-195c-8c549ca01f77.png)

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2023-03-30 17.23.56.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2342443/7f2c0f42-74d0-1fc9-7631-4c20779880a1.png)

ã”æ³¨æ„ãã ã•ã„
:::


yarn V3ã®å ´åˆã«ã¯`.yarnrc`ã§ã¯ãªãã€`.yarnrc.yml`ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
`.yarnrc.yml`ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã§åŒã˜ã“ã¨ãŒã§ãã¾ã™ã€‚


```.yarnrc.yml
yarnPath: .yarn/releases/yarn-3.2.0.cjs
cacheFolder: "/myapp/.yarn/cache"
```
yarn V3ã¯`node-modules`ã§ã¯ãªã`cache`ãƒ•ã‚©ãƒ«ãƒ€çµŒç”±ã§ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã—ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€`cache`ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ãƒ›ã‚¹ãƒˆå´ã§`yarn add`ã‚’ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã‚ˆã†ã«ã§ãã¾ã™ã€‚

```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ yarn add  <package>
Internal Error: ENOENT: no such file or directory, mkdir '/myapp'
Error: ENOENT: no such file or directory, mkdir '/myapp'
```
`yarn install`ã§ã‚‚åŒæ§˜ã§ã™ã€‚
```:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
$ yarn install
Internal Error: ENOENT: no such file or directory, mkdir '/myapp'
Error: ENOENT: no such file or directory, mkdir '/myapp'
```



